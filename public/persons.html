<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Management - Order Management System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë§</text></svg>">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                üì¶ Order Management System
            </a>

            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Orders</a>
                <a class="nav-link active" href="persons.html">Persons</a>
                <a class="nav-link" href="personcredentials.html">User Management</a>
                <a class="nav-link" href="continents.html">Continents</a>
                <a class="nav-link" href="languages.html">Languages</a>
                <a class="nav-link" href="countries.html">Countries</a>

                <div class="nav-item d-flex align-items-center me-3 ms-3">
                    <span class="connection-status connected"></span>
                    <small class="text-muted">Real-time</small>
                </div>

                <button id="themeToggle" class="theme-toggle me-2">
                    üåô
                </button>

                <button id="refreshPersons" class="btn btn-outline-primary btn-sm">
                    <span id="loadingIndicator" class="loading-spinner" style="display: none;"></span>
                    Refresh
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3 mb-0">üë§ Person Management</h1>
                <p class="text-muted">Manage persons with real-time updates</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPersonModal">
                    <i class="bi bi-plus-circle"></i> Add Person
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Total Persons</h6>
                                <h4 class="card-title mb-0" id="totalPersons">0</h4>
                            </div>
                            <div class="stats-icon">üë•</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Active</h6>
                                <h4 class="card-title mb-0" id="activePersons">0</h4>
                            </div>
                            <div class="stats-icon">‚úÖ</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Inactive</h6>
                                <h4 class="card-title mb-0" id="inactivePersons">0</h4>
                            </div>
                            <div class="stats-icon">‚ùå</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Recent</h6>
                                <h4 class="card-title mb-0" id="recentPersons">0</h4>
                            </div>
                            <div class="stats-icon">üïí</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Persons Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Persons List</h5>
                <div class="d-flex gap-2">
                    <input type="search" id="searchPersons" class="form-control form-control-sm" placeholder="Search persons..." style="width: 200px;">
                    <select id="statusFilter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Age</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="personsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading persons...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Person Modal -->
    <div class="modal fade" id="addPersonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPersonForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" name="first_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" name="last_name" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Person</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Person Modal -->
    <div class="modal fade" id="editPersonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPersonForm">
                    <input type="hidden" id="editPersonId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editFirstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="editFirstName" name="first_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editLastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="editLastName" name="last_name" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="editDateOfBirth" name="date_of_birth">
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Person</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="app.js"></script>

    <script>
        // Person Management System
        class PersonManager {
            constructor() {
                this.persons = [];
                this.filteredPersons = [];
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadPersons();
            }

            bindEvents() {
                // Refresh button
                document.getElementById('refreshPersons').addEventListener('click', () => {
                    this.loadPersons();
                });

                // Search
                document.getElementById('searchPersons').addEventListener('input', (e) => {
                    this.filterPersons();
                });

                // Status filter
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filterPersons();
                });

                // Add person form
                document.getElementById('addPersonForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addPerson();
                });

                // Edit person form
                document.getElementById('editPersonForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePerson();
                });
            }

            async loadPersons() {
                try {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    loadingIndicator.style.display = 'inline-block';

                    const response = await fetch('/api/entities/Person');
                    const result = await response.json();

                    if (result.success) {
                        this.persons = result.data || [];
                        this.filteredPersons = [...this.persons];
                        this.renderPersons();
                        this.updateStatistics();
                    } else {
                        throw new Error(result.error || 'Failed to load persons');
                    }
                } catch (error) {
                    console.error('Error loading persons:', error);
                    this.showError('Failed to load persons: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            filterPersons() {
                const searchTerm = document.getElementById('searchPersons').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;

                this.filteredPersons = this.persons.filter(person => {
                    const matchesSearch = !searchTerm ||
                        person.first_name.toLowerCase().includes(searchTerm) ||
                        person.last_name.toLowerCase().includes(searchTerm) ||
                        person.email.toLowerCase().includes(searchTerm) ||
                        (person.phone && person.phone.toLowerCase().includes(searchTerm));

                    const matchesStatus = !statusFilter || person.status === statusFilter;

                    return matchesSearch && matchesStatus;
                });

                this.renderPersons();
            }

            renderPersons() {
                const tbody = document.getElementById('personsTableBody');

                if (this.filteredPersons.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">No persons found</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.filteredPersons.map(person => {
                    const age = this.calculateAge(person.date_of_birth);
                    const statusBadge = person.status === 'active'
                        ? '<span class="badge bg-success">Active</span>'
                        : '<span class="badge bg-secondary">Inactive</span>';

                    return `
                        <tr>
                            <td>${person.id}</td>
                            <td>${person.first_name} ${person.last_name}</td>
                            <td>${person.email}</td>
                            <td>${person.phone || '-'}</td>
                            <td>${age ? age + ' years' : '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${new Date(person.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="personManager.editPerson(${person.id})">
                                        Edit
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="personManager.deletePerson(${person.id})">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            calculateAge(dateOfBirth) {
                if (!dateOfBirth) return null;
                const birthDate = new Date(dateOfBirth);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            updateStatistics() {
                const total = this.persons.length;
                const active = this.persons.filter(p => p.status === 'active').length;
                const inactive = this.persons.filter(p => p.status === 'inactive').length;
                const recent = this.persons.filter(p => {
                    const createdDate = new Date(p.created_at);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return createdDate > weekAgo;
                }).length;

                document.getElementById('totalPersons').textContent = total;
                document.getElementById('activePersons').textContent = active;
                document.getElementById('inactivePersons').textContent = inactive;
                document.getElementById('recentPersons').textContent = recent;
            }

            async addPerson() {
                try {
                    const formData = new FormData(document.getElementById('addPersonForm'));
                    const data = Object.fromEntries(formData.entries());

                    const response = await fetch('/api/entities/person', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('addPersonModal')).hide();
                        document.getElementById('addPersonForm').reset();
                        this.loadPersons();
                        this.showSuccess('Person added successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to add person');
                    }
                } catch (error) {
                    console.error('Error adding person:', error);
                    this.showError('Failed to add person: ' + error.message);
                }
            }

            editPerson(id) {
                const person = this.persons.find(p => p.id == id);
                if (!person) return;

                document.getElementById('editPersonId').value = person.id;
                document.getElementById('editFirstName').value = person.first_name;
                document.getElementById('editLastName').value = person.last_name;
                document.getElementById('editEmail').value = person.email;
                document.getElementById('editPhone').value = person.phone || '';
                document.getElementById('editDateOfBirth').value = person.date_of_birth || '';
                document.getElementById('editStatus').value = person.status;

                new bootstrap.Modal(document.getElementById('editPersonModal')).show();
            }

            async updatePerson() {
                try {
                    const id = document.getElementById('editPersonId').value;
                    const formData = new FormData(document.getElementById('editPersonForm'));
                    const data = Object.fromEntries(formData.entries());

                    const response = await fetch(`/api/entities/person/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('editPersonModal')).hide();
                        this.loadPersons();
                        this.showSuccess('Person updated successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to update person');
                    }
                } catch (error) {
                    console.error('Error updating person:', error);
                    this.showError('Failed to update person: ' + error.message);
                }
            }

            async deletePerson(id) {
                if (!confirm('Are you sure you want to delete this person?')) return;

                try {
                    const response = await fetch(`/api/entities/person/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.loadPersons();
                        this.showSuccess('Person deleted successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to delete person');
                    }
                } catch (error) {
                    console.error('Error deleting person:', error);
                    this.showError('Failed to delete person: ' + error.message);
                }
            }

            showSuccess(message) {
                // You can implement toast notifications here
                alert('Success: ' + message);
            }

            showError(message) {
                // You can implement toast notifications here
                alert('Error: ' + message);
            }
        }

        // Initialize person manager when page loads
        let personManager;
        document.addEventListener('DOMContentLoaded', function() {
            personManager = new PersonManager();
        });
    </script>
</body>
</html>