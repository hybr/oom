<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Management - Order Management System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                üì¶ Order Management System
            </a>

            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Orders</a>
                <a class="nav-link" href="persons.html">Persons</a>
                <a class="nav-link" href="personcredentials.html">User Management</a>
                <a class="nav-link" href="continents.html">Continents</a>
                <a class="nav-link" href="languages.html">Languages</a>
                <a class="nav-link active" href="countries.html">Countries</a>

                <div class="nav-item d-flex align-items-center me-3 ms-3">
                    <span class="connection-status connected"></span>
                    <small class="text-muted">Real-time</small>
                </div>

                <button id="themeToggle" class="theme-toggle me-2">
                    üåô
                </button>

                <button id="refreshCountries" class="btn btn-outline-primary btn-sm">
                    <span id="loadingIndicator" class="loading-spinner" style="display: none;"></span>
                    Refresh
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3 mb-0">üèõÔ∏è Country Management</h1>
                <p class="text-muted">Manage world countries with geographic, economic, and demographic data</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCountryModal">
                    <i class="bi bi-plus-circle"></i> Add Country
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Total Countries</h6>
                                <h4 class="card-title mb-0" id="totalCountries">0</h4>
                            </div>
                            <div class="stats-icon">üèõÔ∏è</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Total Population</h6>
                                <h4 class="card-title mb-0" id="totalPopulation">0</h4>
                            </div>
                            <div class="stats-icon">üë•</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Developed Countries</h6>
                                <h4 class="card-title mb-0" id="developedCountries">0</h4>
                            </div>
                            <div class="stats-icon">üèÜ</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-2">Landlocked</h6>
                                <h4 class="card-title mb-0" id="landlockedCountries">0</h4>
                            </div>
                            <div class="stats-icon">‚õ∞Ô∏è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Countries Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Countries List</h5>
                <div class="d-flex gap-2">
                    <input type="search" id="searchCountries" class="form-control form-control-sm" placeholder="Search countries..." style="width: 200px;">
                    <select id="continentFilter" class="form-select form-select-sm" style="width: 150px;">
                        <option value="">All Continents</option>
                    </select>
                    <select id="developmentFilter" class="form-select form-select-sm" style="width: 150px;">
                        <option value="">All Development</option>
                        <option value="developed">Developed</option>
                        <option value="developing">Developing</option>
                    </select>
                    <select id="sortBy" class="form-select form-select-sm" style="width: 180px;">
                        <option value="">Default Order</option>
                        <option value="name">By Name</option>
                        <option value="population_desc">By Population (Largest)</option>
                        <option value="population_asc">By Population (Smallest)</option>
                        <option value="area_desc">By Area (Largest)</option>
                        <option value="area_asc">By Area (Smallest)</option>
                        <option value="gdp_desc">By GDP (Highest)</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Flag</th>
                                <th>Country</th>
                                <th>Continent</th>
                                <th>Capital</th>
                                <th>Population</th>
                                <th>Area</th>
                                <th>GDP</th>
                                <th>ISO</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="countriesTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading countries...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Country Modal -->
    <div class="modal fade" id="addCountryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Country</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCountryForm">
                    <div class="modal-body">
                        <!-- Basic Information -->
                        <h6>Basic Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Country Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="officialName" class="form-label">Official Name</label>
                                    <input type="text" class="form-control" id="officialName" name="official_name">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="continentId" class="form-label">Continent *</label>
                                    <select class="form-select" id="continentId" name="continent_id" required>
                                        <option value="">Select a continent...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="capital" class="form-label">Capital</label>
                                    <input type="text" class="form-control" id="capital" name="capital">
                                </div>
                            </div>
                        </div>

                        <!-- ISO Codes -->
                        <h6>ISO Codes</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="isoAlpha2" class="form-label">ISO Alpha-2</label>
                                    <input type="text" class="form-control" id="isoAlpha2" name="iso_alpha_2" maxlength="2" placeholder="US">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="isoAlpha3" class="form-label">ISO Alpha-3</label>
                                    <input type="text" class="form-control" id="isoAlpha3" name="iso_alpha_3" maxlength="3" placeholder="USA">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="isoNumeric" class="form-label">ISO Numeric</label>
                                    <input type="text" class="form-control" id="isoNumeric" name="iso_numeric" maxlength="3" placeholder="840">
                                </div>
                            </div>
                        </div>

                        <!-- Geography & Demographics -->
                        <h6>Geography & Demographics</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="areaKm2" class="form-label">Area (km¬≤)</label>
                                    <input type="number" class="form-control" id="areaKm2" name="area_km2" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="population" class="form-label">Population</label>
                                    <input type="number" class="form-control" id="population" name="population" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="flagEmoji" class="form-label">Flag Emoji</label>
                                    <input type="text" class="form-control" id="flagEmoji" name="flag_emoji" maxlength="4" placeholder="üá∫üá∏">
                                </div>
                            </div>
                        </div>

                        <!-- Economy -->
                        <h6>Economy</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="gdpUsd" class="form-label">GDP (USD)</label>
                                    <input type="number" class="form-control" id="gdpUsd" name="gdp_usd" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="gdpPerCapita" class="form-label">GDP Per Capita (USD)</label>
                                    <input type="number" class="form-control" id="gdpPerCapita" name="gdp_per_capita" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="currencyCode" class="form-label">Currency Code</label>
                                    <input type="text" class="form-control" id="currencyCode" name="currency_code" maxlength="3" placeholder="USD">
                                </div>
                            </div>
                        </div>

                        <!-- Location & Government -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="region" class="form-label">Region</label>
                                    <input type="text" class="form-control" id="region" name="region">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="governmentType" class="form-label">Government Type</label>
                                    <select class="form-select" id="governmentType" name="government_type">
                                        <option value="">Select...</option>
                                        <option value="republic">Republic</option>
                                        <option value="monarchy">Monarchy</option>
                                        <option value="federation">Federation</option>
                                        <option value="parliamentary">Parliamentary</option>
                                        <option value="presidential">Presidential</option>
                                        <option value="dictatorship">Dictatorship</option>
                                        <option value="communist">Communist</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Flags -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isLandlocked" name="is_landlocked" value="1">
                                    <label class="form-check-label" for="isLandlocked">
                                        Landlocked Country
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isDeveloped" name="is_developed" value="1">
                                    <label class="form-check-label" for="isDeveloped">
                                        Developed Country
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Country</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="viewDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Country Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer" id="detailsActions">
                    <!-- Actions will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Country Modal -->
    <div class="modal fade" id="editCountryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Country</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editCountryForm">
                    <input type="hidden" id="editCountryId">
                    <div class="modal-body">
                        <!-- Same structure as add form but with edit prefixes -->
                        <h6>Basic Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Country Name *</label>
                                    <input type="text" class="form-control" id="editName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editOfficialName" class="form-label">Official Name</label>
                                    <input type="text" class="form-control" id="editOfficialName" name="official_name">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editContinentId" class="form-label">Continent *</label>
                                    <select class="form-select" id="editContinentId" name="continent_id" required>
                                        <option value="">Select a continent...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCapital" class="form-label">Capital</label>
                                    <input type="text" class="form-control" id="editCapital" name="capital">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editAreaKm2" class="form-label">Area (km¬≤)</label>
                                    <input type="number" class="form-control" id="editAreaKm2" name="area_km2" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editPopulation" class="form-label">Population</label>
                                    <input type="number" class="form-control" id="editPopulation" name="population" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editGdpUsd" class="form-label">GDP (USD)</label>
                                    <input type="number" class="form-control" id="editGdpUsd" name="gdp_usd" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsLandlocked" name="is_landlocked" value="1">
                                    <label class="form-check-label" for="editIsLandlocked">
                                        Landlocked Country
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsDeveloped" name="is_developed" value="1">
                                    <label class="form-check-label" for="editIsDeveloped">
                                        Developed Country
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label for="editIsActive" class="form-label">Active Status</label>
                            <select class="form-select" id="editIsActive" name="is_active">
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Country</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="app.js"></script>

    <script>
        // Country Management System
        class CountryManager {
            constructor() {
                this.countries = [];
                this.continents = [];
                this.filteredCountries = [];
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadContinents();
                this.loadCountries();
            }

            bindEvents() {
                // Refresh button
                document.getElementById('refreshCountries').addEventListener('click', () => {
                    this.loadCountries();
                });

                // Search and filters
                document.getElementById('searchCountries').addEventListener('input', () => {
                    this.filterCountries();
                });

                document.getElementById('continentFilter').addEventListener('change', () => {
                    this.filterCountries();
                });

                document.getElementById('developmentFilter').addEventListener('change', () => {
                    this.filterCountries();
                });

                document.getElementById('sortBy').addEventListener('change', () => {
                    this.filterCountries();
                });

                // Forms
                document.getElementById('addCountryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addCountry();
                });

                document.getElementById('editCountryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateCountry();
                });
            }

            async loadContinents() {
                try {
                    const response = await fetch('/api/entities/Continent');
                    const result = await response.json();

                    if (result.success) {
                        this.continents = result.data || [];
                        this.populateContinentSelects();
                        this.populateContinentFilter();
                    }
                } catch (error) {
                    console.error('Error loading continents:', error);
                }
            }

            populateContinentSelects() {
                const selects = ['continentId', 'editContinentId'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select a continent...</option>';

                    this.continents.forEach(continent => {
                        const option = document.createElement('option');
                        option.value = continent.id;
                        option.textContent = `${continent.name} (${continent.code})`;
                        select.appendChild(option);
                    });
                });
            }

            populateContinentFilter() {
                const select = document.getElementById('continentFilter');
                select.innerHTML = '<option value="">All Continents</option>';

                this.continents.forEach(continent => {
                    const option = document.createElement('option');
                    option.value = continent.id;
                    option.textContent = continent.name;
                    select.appendChild(option);
                });
            }

            async loadCountries() {
                try {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    loadingIndicator.style.display = 'inline-block';

                    const response = await fetch('/api/entities/Country');
                    const result = await response.json();

                    if (result.success) {
                        this.countries = result.data || [];
                        this.filteredCountries = [...this.countries];
                        this.renderCountries();
                        this.updateStatistics();
                    } else {
                        throw new Error(result.error || 'Failed to load countries');
                    }
                } catch (error) {
                    console.error('Error loading countries:', error);
                    this.showError('Failed to load countries: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            filterCountries() {
                const searchTerm = document.getElementById('searchCountries').value.toLowerCase();
                const continentFilter = document.getElementById('continentFilter').value;
                const developmentFilter = document.getElementById('developmentFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                this.filteredCountries = this.countries.filter(country => {
                    const matchesSearch = !searchTerm ||
                        country.name.toLowerCase().includes(searchTerm) ||
                        (country.official_name && country.official_name.toLowerCase().includes(searchTerm)) ||
                        (country.capital && country.capital.toLowerCase().includes(searchTerm)) ||
                        (country.iso_alpha_2 && country.iso_alpha_2.toLowerCase().includes(searchTerm)) ||
                        (country.iso_alpha_3 && country.iso_alpha_3.toLowerCase().includes(searchTerm)) ||
                        (country.region && country.region.toLowerCase().includes(searchTerm));

                    const matchesContinent = !continentFilter || country.continent_id == continentFilter;

                    let matchesDevelopment = true;
                    if (developmentFilter === 'developed') {
                        matchesDevelopment = country.is_developed == 1;
                    } else if (developmentFilter === 'developing') {
                        matchesDevelopment = country.is_developed == 0;
                    }

                    return matchesSearch && matchesContinent && matchesDevelopment;
                });

                // Apply sorting
                if (sortBy) {
                    this.filteredCountries.sort((a, b) => {
                        switch (sortBy) {
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'population_desc':
                                return (b.population || 0) - (a.population || 0);
                            case 'population_asc':
                                return (a.population || 0) - (b.population || 0);
                            case 'area_desc':
                                return (b.area_km2 || 0) - (a.area_km2 || 0);
                            case 'area_asc':
                                return (a.area_km2 || 0) - (b.area_km2 || 0);
                            case 'gdp_desc':
                                return (b.gdp_usd || 0) - (a.gdp_usd || 0);
                            default:
                                return 0;
                        }
                    });
                }

                this.renderCountries();
            }

            renderCountries() {
                const tbody = document.getElementById('countriesTableBody');

                if (this.filteredCountries.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="text-muted">No countries found</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.filteredCountries.map(country => {
                    const continent = this.continents.find(c => c.id == country.continent_id);
                    const continentName = continent ? continent.name : 'Unknown';

                    const flag = country.flag_emoji || 'üèõÔ∏è';
                    const population = this.formatNumber(country.population);
                    const area = country.area_km2 ? this.formatNumber(country.area_km2) + ' km¬≤' : '-';
                    const gdp = country.gdp_usd ? '$' + this.formatNumber(country.gdp_usd) : '-';
                    const iso = [country.iso_alpha_2, country.iso_alpha_3].filter(Boolean).join('/') || '-';

                    const statusBadges = [];
                    if (country.is_developed == 1) statusBadges.push('<span class="badge bg-success">Developed</span>');
                    if (country.is_landlocked == 1) statusBadges.push('<span class="badge bg-warning">Landlocked</span>');
                    if (country.is_active == 0) statusBadges.push('<span class="badge bg-secondary">Inactive</span>');

                    const status = statusBadges.length > 0 ? statusBadges.join(' ') : '<span class="badge bg-light text-dark">-</span>';

                    return `
                        <tr>
                            <td style="font-size: 1.2em;">${flag}</td>
                            <td><strong>${country.name}</strong></td>
                            <td>${continentName}</td>
                            <td>${country.capital || '-'}</td>
                            <td>${population}</td>
                            <td>${area}</td>
                            <td>${gdp}</td>
                            <td><small class="text-muted">${iso}</small></td>
                            <td>${status}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info" onclick="countryManager.viewDetails(${country.id})">
                                        View Details
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="countryManager.editCountry(${country.id})">
                                        Edit
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="countryManager.deleteCountry(${country.id})">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            formatNumber(number) {
                if (!number) return '-';
                if (number >= 1000000000000) {
                    return (number / 1000000000000).toFixed(2) + 'T';
                } else if (number >= 1000000000) {
                    return (number / 1000000000).toFixed(2) + 'B';
                } else if (number >= 1000000) {
                    return (number / 1000000).toFixed(1) + 'M';
                } else if (number >= 1000) {
                    return (number / 1000).toFixed(1) + 'K';
                }
                return new Intl.NumberFormat().format(number);
            }

            updateStatistics() {
                const total = this.countries.length;
                const totalPopulation = this.countries.reduce((sum, c) => sum + (c.population || 0), 0);
                const developed = this.countries.filter(c => c.is_developed == 1).length;
                const landlocked = this.countries.filter(c => c.is_landlocked == 1).length;

                document.getElementById('totalCountries').textContent = total;
                document.getElementById('totalPopulation').textContent = this.formatNumber(totalPopulation);
                document.getElementById('developedCountries').textContent = developed;
                document.getElementById('landlockedCountries').textContent = landlocked;
            }

            async addCountry() {
                try {
                    const formData = new FormData(document.getElementById('addCountryForm'));
                    const data = Object.fromEntries(formData.entries());

                    // Convert numeric and boolean fields
                    ['area_km2', 'population', 'gdp_usd', 'continent_id'].forEach(field => {
                        if (data[field]) data[field] = parseInt(data[field]);
                    });
                    if (data.gdp_per_capita) data.gdp_per_capita = parseFloat(data.gdp_per_capita);
                    ['is_landlocked', 'is_developed'].forEach(field => {
                        data[field] = data[field] ? 1 : 0;
                    });

                    const response = await fetch('/api/entities/Country', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('addCountryModal')).hide();
                        document.getElementById('addCountryForm').reset();
                        this.loadCountries();
                        this.showSuccess('Country added successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to add country');
                    }
                } catch (error) {
                    console.error('Error adding country:', error);
                    this.showError('Failed to add country: ' + error.message);
                }
            }

            viewDetails(id) {
                const country = this.countries.find(c => c.id == id);
                const continent = this.continents.find(c => c.id == country.continent_id);

                if (!country) return;

                const detailsContent = document.getElementById('detailsContent');
                detailsContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr><th width="40%">Flag:</th><td style="font-size: 1.5em;">${country.flag_emoji || 'üèõÔ∏è'}</td></tr>
                                <tr><th>Name:</th><td><strong>${country.name}</strong></td></tr>
                                <tr><th>Official Name:</th><td>${country.official_name || '-'}</td></tr>
                                <tr><th>Continent:</th><td>${continent ? continent.name : 'Unknown'}</td></tr>
                                <tr><th>Capital:</th><td>${country.capital || '-'}</td></tr>
                                <tr><th>Region:</th><td>${country.region || '-'}</td></tr>
                                <tr><th>Government:</th><td>${country.government_type || '-'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Geography & Demographics</h6>
                            <table class="table table-borderless table-sm">
                                <tr><th width="40%">Area:</th><td>${country.area_km2 ? this.formatNumber(country.area_km2) + ' km¬≤' : '-'}</td></tr>
                                <tr><th>Population:</th><td>${this.formatNumber(country.population)}</td></tr>
                                <tr><th>Population Density:</th><td>${country.population_density ? country.population_density.toFixed(2) + '/km¬≤' : '-'}</td></tr>
                                <tr><th>GDP:</th><td>${country.gdp_usd ? '$' + this.formatNumber(country.gdp_usd) : '-'}</td></tr>
                                <tr><th>GDP Per Capita:</th><td>${country.gdp_per_capita ? '$' + country.gdp_per_capita.toLocaleString() : '-'}</td></tr>
                                <tr><th>Currency:</th><td>${country.currency_code || '-'}</td></tr>
                                <tr><th>Calling Code:</th><td>${country.calling_code || '-'}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>ISO Codes</h6>
                            <table class="table table-borderless table-sm">
                                <tr><th width="40%">ISO Alpha-2:</th><td>${country.iso_alpha_2 || '-'}</td></tr>
                                <tr><th>ISO Alpha-3:</th><td>${country.iso_alpha_3 || '-'}</td></tr>
                                <tr><th>ISO Numeric:</th><td>${country.iso_numeric || '-'}</td></tr>
                                <tr><th>Internet TLD:</th><td>${country.internet_tld || '-'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Status & Classification</h6>
                            <table class="table table-borderless table-sm">
                                <tr><th width="40%">Development:</th><td>${country.is_developed == 1 ? 'üèÜ Developed' : 'üå± Developing'}</td></tr>
                                <tr><th>Geography:</th><td>${country.is_landlocked == 1 ? '‚õ∞Ô∏è Landlocked' : 'üåä Coastal'}</td></tr>
                                <tr><th>Status:</th><td>${country.is_active == 1 ? '‚úÖ Active' : '‚ùå Inactive'}</td></tr>
                                <tr><th>Independence:</th><td>${country.independence_date || '-'}</td></tr>
                                <tr><th>Created:</th><td>${new Date(country.created_at).toLocaleString()}</td></tr>
                                <tr><th>Updated:</th><td>${new Date(country.updated_at).toLocaleString()}</td></tr>
                            </table>
                        </div>
                    </div>
                `;

                const detailsActions = document.getElementById('detailsActions');
                detailsActions.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="countryManager.editCountry(${country.id})">Edit</button>
                    ${country.is_active == 1
                        ? `<button type="button" class="btn btn-warning" onclick="countryManager.deactivateCountry(${country.id})">Deactivate</button>`
                        : `<button type="button" class="btn btn-success" onclick="countryManager.activateCountry(${country.id})">Activate</button>`
                    }
                `;

                new bootstrap.Modal(document.getElementById('viewDetailsModal')).show();
            }

            editCountry(id) {
                const country = this.countries.find(c => c.id == id);
                if (!country) return;

                document.getElementById('editCountryId').value = country.id;
                document.getElementById('editName').value = country.name;
                document.getElementById('editOfficialName').value = country.official_name || '';
                document.getElementById('editContinentId').value = country.continent_id;
                document.getElementById('editCapital').value = country.capital || '';
                document.getElementById('editAreaKm2').value = country.area_km2 || '';
                document.getElementById('editPopulation').value = country.population || '';
                document.getElementById('editGdpUsd').value = country.gdp_usd || '';
                document.getElementById('editIsLandlocked').checked = country.is_landlocked == 1;
                document.getElementById('editIsDeveloped').checked = country.is_developed == 1;
                document.getElementById('editIsActive').value = country.is_active;

                bootstrap.Modal.getOrCreateInstance(document.getElementById('viewDetailsModal'))?.hide();
                new bootstrap.Modal(document.getElementById('editCountryModal')).show();
            }

            async updateCountry() {
                try {
                    const id = document.getElementById('editCountryId').value;
                    const formData = new FormData(document.getElementById('editCountryForm'));
                    const data = Object.fromEntries(formData.entries());

                    // Convert numeric and boolean fields
                    ['area_km2', 'population', 'gdp_usd', 'continent_id', 'is_active'].forEach(field => {
                        if (data[field]) data[field] = parseInt(data[field]);
                    });
                    ['is_landlocked', 'is_developed'].forEach(field => {
                        data[field] = data[field] ? 1 : 0;
                    });

                    const response = await fetch(`/api/entities/Country/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('editCountryModal')).hide();
                        this.loadCountries();
                        this.showSuccess('Country updated successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to update country');
                    }
                } catch (error) {
                    console.error('Error updating country:', error);
                    this.showError('Failed to update country: ' + error.message);
                }
            }

            async activateCountry(id) {
                await this.toggleCountryStatus(id, 1);
            }

            async deactivateCountry(id) {
                await this.toggleCountryStatus(id, 0);
            }

            async toggleCountryStatus(id, isActive) {
                try {
                    const response = await fetch(`/api/entities/Country/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ is_active: isActive })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.loadCountries();
                        this.showSuccess(`Country ${isActive ? 'activated' : 'deactivated'} successfully!`);
                        bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal')).hide();
                    } else {
                        throw new Error(result.error || `Failed to ${isActive ? 'activate' : 'deactivate'} country`);
                    }
                } catch (error) {
                    console.error('Error toggling country status:', error);
                    this.showError(`Failed to ${isActive ? 'activate' : 'deactivate'} country: ` + error.message);
                }
            }

            async deleteCountry(id) {
                if (!confirm('Are you sure you want to delete this country? This action cannot be undone.')) return;

                try {
                    const response = await fetch(`/api/entities/Country/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.loadCountries();
                        this.showSuccess('Country deleted successfully!');
                    } else {
                        throw new Error(result.error || 'Failed to delete country');
                    }
                } catch (error) {
                    console.error('Error deleting country:', error);
                    this.showError('Failed to delete country: ' + error.message);
                }
            }

            showSuccess(message) {
                alert('Success: ' + message);
            }

            showError(message) {
                alert('Error: ' + message);
            }
        }

        // Initialize country manager when page loads
        let countryManager;
        document.addEventListener('DOMContentLoaded', function() {
            countryManager = new CountryManager();
        });
    </script>
</body>
</html>